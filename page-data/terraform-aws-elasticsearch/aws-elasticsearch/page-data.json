{"componentChunkName":"component---src-templates-blog-post-js","path":"/terraform-aws-elasticsearch/aws-elasticsearch/","result":{"data":{"site":{"siteMetadata":{"title":"Backtracking Dev","siteUrl":"https://backtracking.dev"}},"markdownRemark":{"id":"5bd206da-2563-5295-a157-bbd88457ea83","excerpt":"Amazon elasticsearch service is a popular choice for many aws clients for log analytics and visualization use cases. One common scenario is to have…","html":"<p>Amazon elasticsearch service is a popular choice for many aws clients for log analytics and visualization use cases. One common scenario is to have elasticsearch (indexing engine) only accessible within vpc and kibana (visualization engine) to be available over the internet through an authentication mechanism. </p>\n<p>Amazon elasticsearch service is a combo of elasticsearch and kibana, and we cannot spawn two components separately. However, the aws team provided the hack to achieve the desired setup using Nginx and Cognito authentication.</p>\n<p>Detailed documentation available at <a href=\"https://aws.amazon.com/premiumsupport/knowledge-center/kibana-outside-vpc-nginx-elasticsearch/\">aws</a>. I referred the same documentation when I first launched the elasticsearch service, but it is quite a lengthy process to get it running. Hence, I thought of creating a Terraform IaC script, handy, and prod ready for deployment. </p>\n<p>We can also use AWS CloudFormation to create an IaC script, but I like the terraform simplicity and philosophy.</p>\n<p>Below diagram shows the components and communication between each other.\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bf2f8d9711c3117524186be307a37915/9dd9c/aws-elasticsearch.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.643678160919535%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsSAAALEgHS3X78AAACaElEQVQ4y21TSWsUURCeH+fNmzf/ggjqxYsXFxQN4gJeRLyJCCISGCQSEnBBoxKJWWQms2QyMz1L9/T09rrf0t3zWa+SiRmxHx/Vb/teVX1VFdDnpxN4yRgqVwR5DHUCfWylUQvr/6KclahYwtX9d9jsfre/mNFgO5udoChL3sHxCT5Fl0tat9YiL3MmrdgL9uuHXXxqryOSAXnsIdUCmREQOqHdEr1AYq0xQShzeEIj0URA62zzkh9mQuumRS84xHpjBU2vhn3vNwZRD8O4D4dsXkqaK6zUxqi5AvWpQK2V4f2LEAduhkAa9pIJrXc2RzN6LdYhQu3Dz1z40oUrhhgnA6hCchSRmWGUaExNia+bLdy/sYzmIFwkdByHCDXCJMDewTZ+7GzgytVLePX2JSbZGIdeG0LGtJ/iV6tHqcnw+ecOHj99huW1Vdx99AT9ScgPWjEr1WoVBY1IhHx5u7GFi5cv4E31NXvZHOwjTiPEIsNux8EgVvi4uU2EzyncELeWHqA79o8IDREWRUE5MtCF5hCnykPTqXOoXjpC1+9QuaSs7SjNmdCiMZyg40UYChIpkaz8qRxqdncUOwxLPLeHbguiUDDtDqY3byO4cw+D3TraQUpCZSRmSjnMiW8uCj1tvbOEc2XZEkaJg67XQphn8L98Q+fMWfTOnUfjwwYOhEGfyLoB7aWGS+uvh0Row45kiFidAs1tXRb2uDvB1rXr2Ft6CEE5E1TricrpXLFYh5ZQmowr3S7O6/I0bJ5tr2iCmfdLWZx0CXdKYY5UtpuGJ0c9+19QBNYaLWFISWUU530Rilq0wB8s2tSc3WwEAAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"aws elasticsearch\"\n        title=\"aws elasticsearch\"\n        src=\"/static/bf2f8d9711c3117524186be307a37915/799d3/aws-elasticsearch.png\"\n        srcset=\"/static/bf2f8d9711c3117524186be307a37915/00d96/aws-elasticsearch.png 148w,\n/static/bf2f8d9711c3117524186be307a37915/0b23c/aws-elasticsearch.png 295w,\n/static/bf2f8d9711c3117524186be307a37915/799d3/aws-elasticsearch.png 590w,\n/static/bf2f8d9711c3117524186be307a37915/9dd9c/aws-elasticsearch.png 696w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li>vpc and subnets to restrict the access of components</li>\n<li>elasticsearch service to be created within a private subnet</li>\n<li>cognito service(user pool and identity pool) which is used by elasticsearch service for authentication</li>\n<li>nginx instance will be placed in public subnet, which will act as a proxy for kibana access.</li>\n<li>security groups - kibana is only accessible through nginx over 443 port, and nginx public dns will be accessible over internet from port 443.</li>\n</ul>\n<p>Terraform code is available at <a href=\"https://github.com/pariksheet/terraform-aws-elasticsearch\">github</a></p>\n<p>Terraform quick code walkthrough:</p>\n<ul>\n<li>\n<p>project structure</p>\n<ul>\n<li>\n<p>commons</p>\n<ul>\n<li>\n<p>confiugure_nginx.sh </p>\n<p> An userdata script which installs and configures the nginx server. </p>\n</li>\n<li>\n<p>nginx.conf</p>\n<p> Nginx configuration file referred by nginx script. </p>\n</li>\n</ul>\n</li>\n<li>\n<p>main</p>\n<ul>\n<li>\n<p>main.tf</p>\n<p> Launcher terraform script. </p>\n</li>\n<li>\n<p>vars.tf</p>\n<p> List of variables referred in the terraform main script. </p>\n</li>\n<li>\n<p>terraform.tfvars</p>\n<p> Variable values to be passed to terraform main script. </p>\n</li>\n</ul>\n</li>\n<li>\n<p>modules</p>\n<ul>\n<li>\n<p>elasticsearch</p>\n<p> Module consists of three sub modules. </p>\n- cognito\n    <p> Create user pool and indentity pool. </p>\n- elasticsearch_domain\n    <p> Create elasticsearch domain with cognito authentication. </p>\n- nginx\n    <p> Launch nginx instance and configure it to access kibana. </p>\n</li>\n<li>\n<p>vpc</p>\n<ul>\n<li>\n<p>vpc_base</p>\n<p> Create vpc, subnets, route tables and internet gatway. </p>\n</li>\n<li>\n<p>vpc_sg</p>\n<p> Create security groups and ingress/egress rules. </p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>input variables</p>\n<div class=\"gatsby-highlight\" data-language=\"terraformvariable \"aws_region\" \"><pre class=\"language-terraformvariable \"aws_region\" \"><code class=\"language-terraformvariable \"aws_region\" \">variable &quot;PREFIX&quot; { description = &quot;Typically project name&quot; }\nvariable &quot;ENV&quot; { description = &quot;Environment Name&quot; }\nvariable &quot;SUBNET&quot; { description = &quot;VPC CIDR : 10.{var.SUBNET}.0.0/22&quot;}\nvariable &quot;INSTANCE_KEY_PATH&quot; { description = &quot;path of instance pem file&quot; }\nvariable &quot;NGINX_INSTANCE&quot; { description = &quot;instance type of nginx&quot;}\nvariable &quot;ES_INSTANCE&quot; { description = &quot;instance type of elasticsearch&quot;}\nvariable &quot;ES_VOLUME_GB&quot; { description = &quot;instance volume(gb) of elasticsearch&quot;}\nvariable &quot;ES_ENCRYPTION&quot; { description = &quot;true/false&quot;}</code></pre></div>\n</li>\n<li>\n<p>output variables</p>\n<div class=\"gatsby-highlight\" data-language=\"terraform\"><pre class=\"language-terraform\"><code class=\"language-terraform\">elasticsearch = {\n&quot;es_arn&quot; = &quot;arn:aws:es:eu-west-1:856753410642:domain/blog-dev-elastic-search&quot;\n&quot;es_endpoint&quot; = &quot;vpc-blog-dev-elastic-search-wpeo7jzj3s76bgr3porui5e3x4.eu-west-1.es.amazonaws.com&quot;\n&quot;kibana_public_url&quot; = &quot;https://ec2-54-74-236-213.eu-west-1.compute.amazonaws.com&quot;\n&quot;kibana_vpc_url&quot; = &quot;https://vpc-blog-dev-elastic-search-wpeo7jzj3s76bgr3porui5e3x4.eu-west-1.es.amazonaws.com/_plugin/kibana/&quot;\n&quot;user_pool&quot; = &quot;BLOG_DEV_USER_POOL&quot;\n}\nnginx = {\n&quot;private_ip&quot; = &quot;10.33.0.142&quot;\n&quot;public_ip&quot; = &quot;54.74.236.213&quot;\n&quot;ssh_cmd&quot; = &quot;ssh -i ./keypair/nginx-instance ec2-user@i-08fc027f1db5542fc&quot;\n}</code></pre></div>\n</li>\n<li>\n<p>execution of script</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">terraform apply</code></pre></div>\n</li>\n</ul>\n<p>This blog post did not cover terraform basics on how to write each component. There are good materials available over web. I have created a bootcamp for terraform noobs, here is the <a href=\"https://github.com/pariksheet/terraform-bootcamp\">github</a> link.</p>\n<p>Feel free to ask any specific question over comment section.</p>\n<p>Cheers. Happy Coding…!!!</p>","frontmatter":{"title":"Terraform script for Amazon Elasticsearch Service with Cognito authentication","tags":["aws","terraform","elasticsearch","cognito","nginx"],"date":"September 24, 2020","description":"Terraform script for Amazon Elasticsearch Service with Cognito authentication","author":"pari","featuredImage":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAHABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAIDBf/EABUBAQEAAAAAAAAAAAAAAAAAAAED/9oADAMBAAIQAxAAAAG3TKsxI//EABoQAAICAwAAAAAAAAAAAAAAAAERAAIDEyL/2gAIAQEAAQUCwo3Gxdz/xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPwFn/8QAFhEAAwAAAAAAAAAAAAAAAAAAAxAx/9oACAECAQE/AS1f/8QAGhABAAEFAAAAAAAAAAAAAAAAAQACESExcf/aAAgBAQAGPwIBmUvybpn/xAAaEAACAwEBAAAAAAAAAAAAAAAAARExUWGR/9oACAEBAAE/IZOk9V0LH1poLXgz/9oADAMBAAIAAwAAABCID//EABURAQEAAAAAAAAAAAAAAAAAABAx/9oACAEDAQE/EKP/xAAWEQEBAQAAAAAAAAAAAAAAAAABEBH/2gAIAQIBAT8QWAn/xAAbEAEAAgMBAQAAAAAAAAAAAAABABEhMWFR0f/aAAgBAQABPxBJxXspl7DotGGxymCuQ8+0/9k=","aspectRatio":3,"src":"/static/6b48fda7ccb0043bbdd4bef6dc533a05/842c2/es-terraform.jpg","srcSet":"/static/6b48fda7ccb0043bbdd4bef6dc533a05/00e5e/es-terraform.jpg 200w,\n/static/6b48fda7ccb0043bbdd4bef6dc533a05/1a903/es-terraform.jpg 400w,\n/static/6b48fda7ccb0043bbdd4bef6dc533a05/842c2/es-terraform.jpg 720w","sizes":"(max-width: 720px) 100vw, 720px"}}}}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/terraform-aws-elasticsearch/aws-elasticsearch/","previous":{"fields":{"slug":"/working-with-cassandra/"},"frontmatter":{"author":"abhi","tags":["cassandra","performance","nosql","kubernetes"],"title":"Working with cassandra at scale"}},"next":{"fields":{"slug":"/gatsby-blog-github-hosting-ci-cd/"},"frontmatter":{"author":"abhi","tags":["Gatsby","CI/CD","Continuous deployment","blog hosting","experiece"],"title":"Lightning fast personal Blog with github hosting and continuous deployment"}}}}}